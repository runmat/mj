@using CkgDomainLogic.Fahrzeugbestand.Models
@{
    var gridName = "GridFahrzeugAkteBestand";
}
<h4>
    <span>@Localize.PleaseChooseOneOrMoreVehicles</span>
    <span id="FahrzeugAuswahlCount" class="alert alert-success margin-left-15 hide">
        <i class="icon-check"></i><span class="padding-left-5 bold"></span>
    </span>
</h4>

@(Html.Telerik()
    .Grid<FahrzeugAkteBestand>()
    .Name(gridName)
    .XAjaxDataBinding("FahrzeugAkteBestandAjaxBinding", "Fahrzeugbestand")
    .Columns(columns =>
        {
            columns.XBound(c => c.Aktion)
                .ClientTemplate("<input type='checkbox' name='checkedRecords' <# if (data.IsSelected) { #> checked <# } #> value='<#= data.FinID #>' onchange='OnSelectionChange_GridFahrzeugAuswahl($(this))' />")
                .HeaderTemplate(
                    "<span class='tooltips' data-original-title='" + Localize.MultiSelectCheckAllFilteredItems + "' data-placement='right'><input type='checkbox' id='checkAllRecords' onchange='OnAllSelectionChange_GridFahrzeugAuswahl(true)' /></span>" +
                    "<i class='icon-remove cursor-pointer tooltips' data-original-title='" + Localize.MultiSelectUncheckAllFilteredItems + "' data-placement='right' id='uncheckAllRecords' onclick='OnAllSelectionChange_GridFahrzeugAuswahl(false)'></i>"
                ).Filterable(false);
            columns.XBound(c => c.FinID).Title("").Filterable(false).Groupable(false).Sortable(false)
                .ClientTemplate(
                      "<a href='#' onclick='return FahrzeugShowAjax(\"<#= data.FinID #>\");' class='btn mini gray tooltips' data-original-title='" + Localize.Autohaus_Fahrzeugakte + "' data-placement='right'><i class='halflings-icon white pencil'></i></a>" +
                      "<a href='../../autohaus/zulassung/index?finid=<#= data.FinID #>' class='btn mini gray margin-left-10 tooltips' data-original-title='" + Localize.VehicleRegister + "' data-placement='right'><i class='halflings-icon white tag'></i></a>"
                )
                .HeaderTemplate(
                      "<a href='#' onclick='return FahrzeugCreateAjax();' class='btn mini gray tooltips' data-original-title='" + Localize.VehicleCreate + "' data-placement='right'><i class='halflings-icon white plus'></i></a>"
                );
            columns.XBoundAllExcept(m => m.Bemerkung, m => m.CocVorhanden, m => m.VorhandenesKennzReservieren, m => m.IsSelected, m => m.Zb2Nr, m => m.WunschKennz1, m => m.WunschKennz2, m => m.WunschKennz3, m => m.ResKennz, m => m.ReservationName, m => m.ReservationNr, m => m.Evb, m => m.BestellNr, m => m.Kostenstelle, m => m.TuevAu, m => m.IsSchnellabmeldungSpeicherrelevant);
        })
    .XAutoColumnConfiguration()
    .ClientEvents(events => events.OnDataBound("OnDataBound_" + gridName).OnRowDataBound("OnRowDataBound_" + gridName))
    .XPageSize(10)
    .XSort(sortOrder => sortOrder.Add(c => c.FIN).Ascending())
    .XToolBar("Fahrzeugbestand")
)

<div class="form-actions clearfix">
    <div class="pull-left">
        <a id="btnMultiReg" class="btn blue hide" href="MultiReg">@Localize.MassRegistration</a>
        <a id="btnMultiCancellation" class="btn yellow hide" href="MultiCancellation">@Localize.MassCancellation</a>
        <a id="btnDelete" class="btn blue hide" onclick="DeleteFahrzeuge();">@Localize.Delete</a>
    </div>
</div>

<script>

    function OnDataBound_GridFahrzeugAkteBestand() {
        // alert("OnDataBound_GridFahrzeugAkteBestand");
        FilteredData_Grid_OnDataBound($(this));
        $('.tooltips').tooltip();

        // prepare multi row selection
        App.initUniform();
        Grid_PrepareMultiRowSelected("GridFahrzeugAkteBestand");
    }
    function OnRowDataBound_GridFahrzeugAkteBestand(e) {
        // alert("OnRowDataBound_GridFahrzeugAkteBestand");
        $(e.row).addClass((e.row.sectionRowIndex % 2 == 0) ? "t-grid-selected" : "t-grid-selected-alt");
    }

    function OnSelectionChange_GridFahrzeugAuswahl(cb) {
        Grid_FormatMultiRowSelected(cb);
        $.ajax({
            type: "POST",
            url: "FahrzeugAuswahlSelectionChanged",
            data: { id: cb.val(), isChecked: cb.is(':checked') },
            loadingShow: false,
            success: function (result) {
                _selectedItemsCount = result.allSelectionCount;
                GridFahrzeugAuswahl_MultiSelectUpdate(_selectedItemsCount);
                RefreshZulassungenCountForDateAndPdi(result.zulassungenAnzahlGesamtTotal, result.zulassungenAnzahlPdiTotal);
                ShowHideButtons();
                if (_selectedItemsCount == 0) {
                    $("#FahrzeugAuswahlCount").addClass('hide');
                    return;
                }

                $("#FahrzeugAuswahlCount").removeClass('hide');
                $("#FahrzeugAuswahlCount > span").html('Sie haben ' + _selectedItemsCount + ' Fahrzeug' + (_selectedItemsCount == 1 ? '' : 'e') + ' ausgewählt!');
            }
        });
    }

    function OnAllSelectionChange_GridFahrzeugAuswahl(check) {
        $.ajax({
            type: "POST",
            url: "FahrzeugAuswahlSelectionChanged",
            data: { id: "", isChecked: check },
            loadingShow: true,
            success: function (result) {
                _selectedItemsCount = result.allSelectionCount;
                GridFahrzeugAuswahl_MultiSelectUpdate(_selectedItemsCount);
                RefreshZulassungenCountForDateAndPdi(result.zulassungenAnzahlGesamtTotal, result.zulassungenAnzahlPdiTotal);
                ShowHideButtons();

                FilterGrid("@gridName");
            }
        });
    }

    function GridFahrzeugAuswahl_MultiSelectUpdate(count) {        
        if (count == 0) {
            $("#FahrzeugAuswahlCount").addClass('hide');
            $("#uncheckAllRecords").attr("checked", false);
            $.uniform.update($("#uncheckAllRecords"));
            return;
        }

        $("#FahrzeugAuswahlCount").removeClass('hide');
        $("#FahrzeugAuswahlCount > span").html('Sie haben ' + count + ' Fahrzeug' + (count == 1 ? '' : 'e') + ' ausgewählt!');
        $("#uncheckAllRecords").attr("checked", true);
    }

    function RefreshFahrzeugGrid() {
        $("#GridFahrzeugAkteBestand").data("tGrid").ajaxRequest();
    }

    function RefreshZulassungenCountForDateAndPdi(zulassungenAnzahlGesamtTotal, zulassungenAnzahlPdiTotal) {        
        if (zulassungenAnzahlGesamtTotal == 0)
            $("#zulassungenAnzahlGesamtTotal").addClass("hide");
        else {
            $("#zulassungenAnzahlGesamtTotal").html("@Localize.RegistrationAmountForThisDay: " + zulassungenAnzahlGesamtTotal);
            $("#zulassungenAnzahlGesamtTotal").removeClass("hide");
        }

        if (zulassungenAnzahlPdiTotal == 0)
            $("#zulassungenAnzahlPdiTotal").addClass("hide");
        else {
            $("#zulassungenAnzahlPdiTotal").html("@Localize.RegistrationAmountForThisDayAndPdi: " + zulassungenAnzahlPdiTotal);
            $("#zulassungenAnzahlPdiTotal").removeClass("hide");
        }
    }

    function ShowHideButtons() {
        if (_selectedItemsCount > 0) {
            $('#btnDelete').removeClass('hide');
        } else {
            $('#btnDelete').addClass('hide');
        }

        if (_selectedItemsCount > 1) {
            $('#btnMultiReg').removeClass('hide');
            $('#btnMultiCancellation').removeClass('hide');
        } else {
            $('#btnMultiReg').addClass('hide');
            $('#btnMultiCancellation').addClass('hide');
        }
    }

    function DeleteFahrzeuge() {
        $.ajax({
            type: "POST",
            url: "DeleteFahrzeuge",
            loadingShow: true,
            success: function (result) {

                if (result.success) {

                    RefreshFahrzeugGrid();

                    _selectedItemsCount = result.allSelectionCount;
                    GridFahrzeugAuswahl_MultiSelectUpdate(_selectedItemsCount);
                    RefreshZulassungenCountForDateAndPdi(result.zulassungenAnzahlGesamtTotal, result.zulassungenAnzahlPdiTotal);
                    ShowHideButtons();
                    if (_selectedItemsCount == 0) {
                        $("#FahrzeugAuswahlCount").addClass('hide');
                        return;
                    }

                    $("#FahrzeugAuswahlCount").removeClass('hide');
                    $("#FahrzeugAuswahlCount > span").html('Sie haben ' + _selectedItemsCount + ' Fahrzeug' + (_selectedItemsCount == 1 ? '' : 'e') + ' ausgewählt!');

                } else {
                    SpanAlertError("Message", result.message, 5000);
                }

                LoadingHide();
            }
        });
    }
    
</script>
